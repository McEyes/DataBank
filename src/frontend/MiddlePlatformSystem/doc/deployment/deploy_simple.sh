#!/bin/bash
set -e

# ==============================================================================
# 网站部署简化脚本
# 功能：备份当前站点、清理目标目录、部署新站点
# 作者：AI Assistant
# 日期：2025-10-23
# ==============================================================================

# ------------------------------------------------------------------------------
# 配置参数
# ------------------------------------------------------------------------------
# 备份根目录（当前目录）
BACKUP_ROOT="."

# 目标站点目录
TARGET_DIR="/usr/local/app/websites/dataops/"

# 新站点源目录
SOURCE_DIR="/home/3223901/src/Data Asset Management.NorthAsia.HUA/WebApp/DataOps.Web/"

# 时间戳
TIMESTAMP=$(date +%Y%m%d%H%M%S)

# 备份目录
BACKUP_DIR="${BACKUP_ROOT}/backup/DataOps.Web_${TIMESTAMP}"

# ------------------------------------------------------------------------------
# 显示信息
# ------------------------------------------------------------------------------
echo "========================================"
echo "网站部署简化脚本"
echo "========================================"
echo "备份目录:     $BACKUP_DIR"
echo "目标站点目录: $TARGET_DIR"
echo "新站点源目录: $SOURCE_DIR"
echo "========================================"
echo

# ------------------------------------------------------------------------------
# 确认执行
# ------------------------------------------------------------------------------
read -p "是否继续执行部署流程？[y/N] " confirm
if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "用户取消了部署操作"
    exit 0
fi

# ------------------------------------------------------------------------------
# 创建备份
# ------------------------------------------------------------------------------
echo "开始创建站点备份..."
if ! mkdir -p "$BACKUP_DIR"; then
    echo "普通用户无法创建备份目录，尝试使用sudo..."
    if ! sudo mkdir -p "$BACKUP_DIR"; then
        echo "无法创建备份目录"
        exit 1
    fi
fi

echo "正在复制站点文件到备份目录..."
if ! cp -r "${TARGET_DIR}/." "${BACKUP_DIR}/"; then
    echo "普通用户复制失败，尝试使用sudo..."
    if ! sudo cp -r "${TARGET_DIR}/." "${BACKUP_DIR}/"; then
        echo "备份失败"
        exit 1
    fi
fi

echo "备份完成: ${BACKUP_DIR}"
echo

# ------------------------------------------------------------------------------
# 清理目标目录
# ------------------------------------------------------------------------------
echo "开始清理目标目录..."

# 确认删除操作
read -p "确定要删除 ${TARGET_DIR} 目录下的所有文件吗？[y/N] " confirm
if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "用户取消了删除操作"
    exit 0
fi

# 执行删除
echo "正在删除目标目录内容..."
if ! rm -rf "${TARGET_DIR:?}"/*; then
    echo "普通用户删除失败，尝试使用sudo..."
    if ! sudo rm -rf "${TARGET_DIR:?}"/*; then
        echo "清理目标目录失败"
        exit 1
    fi
fi

echo "目标目录清理完成"
echo

# ------------------------------------------------------------------------------
# 部署新站点
# ------------------------------------------------------------------------------
echo "开始部署新站点..."

# 执行复制
echo "正在将新站点文件复制到目标目录..."
if ! cp -r "${SOURCE_DIR}/." "${TARGET_DIR}/"; then
    echo "普通用户复制失败，尝试使用sudo..."
    if ! sudo cp -r "${SOURCE_DIR}/." "${TARGET_DIR}/"; then
        echo "部署失败"
        exit 1
    fi
fi

echo "新站点部署完成"
echo

# ------------------------------------------------------------------------------
# 完成
# ------------------------------------------------------------------------------
echo "========================================"
echo "部署流程全部完成！"
echo "备份位置: ${BACKUP_DIR}"
echo "目标站点: ${TARGET_DIR}"
echo "========================================"
