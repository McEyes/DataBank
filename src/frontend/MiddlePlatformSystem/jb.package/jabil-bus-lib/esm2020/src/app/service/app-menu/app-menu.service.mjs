import { Injectable } from '@angular/core';
import en from '../translate/en.json';
import cn from '../translate/cn.json';
import * as i0 from "@angular/core";
let self = {};
export class AppMenuService {
    constructor() {
        this.defaultCheckedKeys = [];
        this.translateObj = {};
        self = this;
        const currentLanguage = localStorage.getItem('lang') || 'en';
        this.translateObj = currentLanguage === 'en' ? en : cn;
    }
    async getMenuData(menuTreeKeys, menuTree) {
        this.defaultCheckedKeys = [];
        menuTreeKeys.data.forEach((item) => {
            this.defaultCheckedKeys.push(item.menuInfoId);
        });
        this.buildTableTreeData(menuTree.data);
        if (menuTree.data.length === 0) {
            return [
                {
                    label: this.translateObj['Home'],
                    routerLink: '/common/home',
                    key: 'DefaultPage',
                    icon: '',
                    url: undefined,
                    items: undefined,
                },
            ];
        }
        menuTree.data.sort((a, b) => {
            return a.sort - b.sort;
        });
        this.sortMenu(menuTree.data);
        return menuTree.data.length === 1 && menuTree.data[0].items ? menuTree.data[0].items : menuTree.data;
    }
    sortMenu(data) {
        for (let i = 0; i < data.length; i++) {
            data[i].items?.sort((a, b) => {
                return a.sort - b.sort;
            });
            if (data[i].items) {
                this.sortMenu(data[i].items);
            }
        }
    }
    buildTableTreeData(data, pName, greatPName) {
        const isHttps = document.location.protocol === 'https:';
        for (let index = 0; index < data.length; index++) {
            if (!this.defaultCheckedKeys.includes(data[index].menuInfo.id) ||
                data[index].menuInfo.isHidden || (data[index].menuInfo.isDisableNet && isHttps)) {
                data.splice(index, 1);
                index--;
                // data[index].visible = false;
                continue;
            }
            data[index].label =
                this.translateObj[data[index].menuInfo.title] || data[index].menuInfo.title;
            data[index].key = data[index].menuInfo.id;
            data[index].routerLink = data[index].menuInfo.path === '/' ? '' : data[index].menuInfo.path;
            data[index].routerPath = data[index].menuInfo.path === '/' ? '' : data[index].menuInfo.path;
            data[index].icon = data[index].menuInfo.icon;
            data[index].sort = data[index].menuInfo.sort;
            data[index].webAppPath = this.getWebApp(data[index].menuInfo?.webAppPath) || '';
            data[index].webAppRoute = data[index].menuInfo?.webAppRoute || '';
            data[index].isWebApp = !!data[index].menuInfo?.isWebApp;
            data[index].routerLink = data[index].menuInfo?.isWebApp ? data[index].webAppRoute : data[index].routerLink;
            data[index].routerLinkActiveOptions = { exact: !!data[index].menuInfo?.isWebApp };
            data[index].url = undefined;
            data[index].pName = pName;
            data[index].greatPName = greatPName;
            data[index].items =
                data[index].menuChildren.length > 0 ? data[index].menuChildren : undefined;
            if (data[index].menuChildren && data[index].menuChildren.length > 0) {
                this.buildTableTreeData(data[index].menuChildren, data[index].label, data[index]?.pName);
            }
        }
    }
    getWebApp(str) {
        if (!str || !(str?.includes('modules'))) {
            return str;
        }
        const urls = str.split('modules');
        if (urls.length > 0) {
            return location.origin + '/modules' + (urls[1] || '');
        }
        else {
            return str;
        }
    }
    isExternalNetwork() {
    }
    getMenuInfo(menuTreeKeys, menuTree, key) {
        let menu = null;
        menuTree.forEach((item) => {
            if (item.menuInfo.id === key) {
                menu = item;
            }
        });
        this.buildMenuData([menu], menuTreeKeys);
        return menu;
    }
    buildMenuData(data, menuTreeKeys) {
        for (let i = 0; i < data.length; i++) {
            const index = menuTreeKeys.findIndex((item) => {
                return data[i].menuInfo.id === item.menuInfoId;
            });
            if (index < 0) {
                data.splice(i, 1);
                i--;
                continue;
            }
            if (data[i].menuChildren && data[i].menuChildren.length > 0) {
                this.buildMenuData(data[i].menuChildren, menuTreeKeys);
            }
        }
    }
}
AppMenuService.ɵfac = function AppMenuService_Factory(t) { return new (t || AppMenuService)(); };
AppMenuService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: AppMenuService, factory: AppMenuService.ɵfac });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(AppMenuService, [{
        type: Injectable
    }], function () { return []; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLW1lbnUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9hcHAvc2VydmljZS9hcHAtbWVudS9hcHAtbWVudS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDdEMsT0FBTyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7O0FBRXRDLElBQUksSUFBSSxHQUFRLEVBQUUsQ0FBQztBQUVuQixNQUFNLE9BQU8sY0FBYztJQUl6QjtRQUhRLHVCQUFrQixHQUFlLEVBQUUsQ0FBQztRQUNwQyxpQkFBWSxHQUFRLEVBQUUsQ0FBQztRQUk3QixJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ1osTUFBTSxlQUFlLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxJQUFJLENBQUM7UUFDN0QsSUFBSSxDQUFDLFlBQVksR0FBRyxlQUFlLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUN6RCxDQUFDO0lBRU0sS0FBSyxDQUFDLFdBQVcsQ0FBQyxZQUFpQixFQUFFLFFBQWE7UUFFdkQsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEVBQUUsQ0FBQztRQUM3QixZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQVMsRUFBRSxFQUFFO1lBQ3RDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ2hELENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV2QyxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUM5QixPQUFPO2dC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Q0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7WUFDNUYsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7WUFDNUYsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztZQUM3QyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQzdDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNoRixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLEVBQUUsV0FBVyxJQUFJLEVBQUUsQ0FBQztZQUNsRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQztZQUN4RCxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsVUFBVSxDQUFBO1lBQzFHLElB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SUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQzNELElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksRUFBRSxZQUFZLENBQUMsQ0FBQzthQUN4RDtTQUNGO0lBQ0gsQ0FBQzs7NEVBeElVLGNBQWM7b0VBQWQsY0FBYyxXQUFkLGNBQWM7dUZBQWQsY0FBYztjQUQxQixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgZW4gZnJvbSAnLi4vdHJhbnNsYXRlL2VuLmpzb24nO1xyXG5pbXBvcnQgY24gZnJvbSAnLi4vdHJhbnNsYXRlL2NuLmpzb24nO1xyXG5cclxubGV0IHNlbGY6IGFueSA9IHt9O1xyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBBcHBNZW51U2VydmljZSB7XHJcbiAgcHJpdmF0ZSBkZWZhdWx0Q2hlY2tlZEtleXM6IEFycmF5PGFueT4gPSBbXTtcclxuICBwcml2YXRlIHRyYW5zbGF0ZU9iajogYW55ID0ge307XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICkge1xyXG4gICAgc2VsZiA9IHRoaXM7XHJcbiAgICBjb25zdCBjdXJyZW50TGFuZ3VhZ2UgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnbGFuZycpIHx8ICdlbic7XHJcbiAgICB0aGlzLnRyYW5zbGF0ZU9iaiA9IGN1cnJlbnRMYW5ndWFnZSA9PT0gJ2VuJyA/IGVuIDogY247XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgZ2V0TWVudURhdGEobWVudVRyZWVLZXlzOiBhbnksIG1lbnVUcmVlOiBhbnkpIHtcclxuXHJcbiAgICB0aGlzLmRlZmF1bHRDaGVja2VkS2V5cyA9IFtdO1xyXG4gICAgbWVudVRyZWVLZXlzLmRhdGEuZm9yRWFjaCgoaXRlbTogYW55KSA9PiB7XHJcbiAgICAgIHRoaXMuZGVmYXVsdENoZWNrZWRLZXlzLnB1c2goaXRlbS5tZW51SW5mb0lkKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMuYnVpbGRUYWJsZVRyZWVEYXRhKG1lbnVUcmVlLmRhdGEpO1xyXG5cclxuICAgIGlmIChtZW51VHJlZS5kYXRhLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4gW1xyXG4gICAgICAgIHtcclxuICAgICAgICAgIGxhYmVsOiB0aGlzLnRyYW5zbGF0ZU9ialsnSG9tZSddLFxyXG4gICAgICAgICAgcm91dGVyTGluazogJy9jb21tb24vaG9tZScsXHJcbiAgICAgICAgICBrZXk6ICdEZWZhdWx0UGFnZScsXHJcbiAgICAgICAgICBpY29uOiAnJyxcclxuICAgICAgICAgIHVybDogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgaXRlbXM6IHVuZGVmaW5lZCxcclxuICAgICAgICB9LFxyXG4gICAgICBdO1xyXG4gICAgfVxyXG5cclxuICAgIG1lbnVUcmVlLmRhdGEuc29ydCgoYTogYW55LCBiOiBhbnkpID0+IHtcclxuICAgICAgcmV0dXJuIGEuc29ydCAtIGIuc29ydDtcclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMuc29ydE1lbnUobWVudVRyZWUuZGF0YSk7XHJcblxyXG4gICAgcmV0dXJuIG1lbnVUcmVlLmRhdGEubGVuZ3RoID09PSAxICYmIG1lbnVUcmVlLmRhdGFbMF0uaXRlbXMgPyBtZW51VHJlZS5kYXRhWzBdLml0ZW1zIDogbWVudVRyZWUuZGF0YTtcclxuICB9XHJcblxyXG4gIHNvcnRNZW51KGRhdGE6IEFycmF5PGFueT4pIHtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xyXG4gICAgICBkYXRhW2ldLml0ZW1zPy5zb3J0KChhOiBhbnksIGI6IGFueSkgPT4ge1xyXG4gICAgICAgIHJldHVybiBhLnNvcnQgLSBiLnNvcnQ7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgaWYgKGRhdGFbaV0uaXRlbXMpIHtcclxuICAgICAgICB0aGlzLnNvcnRNZW51KGRhdGFbaV0uaXRlbXMpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBidWlsZFRhYmxlVHJlZURhdGEoZGF0YTogYW55LCBwTmFtZT86IHN0cmluZywgZ3JlYXRQTmFtZT86IHN0cmluZykge1xyXG4gICAgY29uc3QgaXNIdHRwcyA9IGRvY3VtZW50LmxvY2F0aW9uLnByb3RvY29sID09PSAnaHR0cHM6JztcclxuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBkYXRhLmxlbmd0aDsgaW5kZXgrKykge1xyXG4gICAgICBpZiAoXHJcbiAgICAgICAgIXRoaXMuZGVmYXVsdENoZWNrZWRLZXlzLmluY2x1ZGVzKGRhdGFbaW5kZXhdLm1lbnVJbmZvLmlkKSB8fFxyXG4gICAgICAgIGRhdGFbaW5kZXhdLm1lbnVJbmZvLmlzSGlkZGVuIHx8IChkYXRhW2luZGV4XS5tZW51SW5mby5pc0Rpc2FibGVOZXQgJiYgaXNIdHRwcylcclxuICAgICAgKSB7XHJcbiAgICAgICAgZGF0YS5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgIGluZGV4LS07XHJcbiAgICAgICAgLy8gZGF0YVtpbmRleF0udmlzaWJsZSA9IGZhbHNlO1xyXG4gICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBkYXRhW2luZGV4XS5sYWJlbCA9XHJcbiAgICAgICAgdGhpcy50cmFuc2xhdGVPYmpbZGF0YVtpbmRleF0ubWVudUluZm8udGl0bGVdIHx8IGRhdGFbaW5kZXhdLm1lbnVJbmZvLnRpdGxlO1xyXG4gICAgICBkYXRhW2luZGV4XS5rZXkgPSBkYXRhW2luZGV4XS5tZW51SW5mby5pZDtcclxuICAgICAgZGF0YVtpbmRleF0ucm91dGVyTGluayA9IGRhdGFbaW5kZXhdLm1lbnVJbmZvLnBhdGggPT09ICcvJyA/ICcnIDogZGF0YVtpbmRleF0ubWVudUluZm8ucGF0aDtcclxuICAgICAgZGF0YVtpbmRleF0ucm91dGVyUGF0aCA9IGRhdGFbaW5kZXhdLm1lbnVJbmZvLnBhdGggPT09ICcvJyA/ICcnIDogZGF0YVtpbmRleF0ubWVudUluZm8ucGF0aDtcclxuICAgICAgZGF0YVtpbmRleF0uaWNvbiA9IGRhdGFbaW5kZXhdLm1lbnVJbmZvLmljb247XHJcbiAgICAgIGRhdGFbaW5kZXhdLnNvcnQgPSBkYXRhW2luZGV4XS5tZW51SW5mby5zb3J0O1xyXG4gICAgICBkYXRhW2luZGV4XS53ZWJBcHBQYXRoID0gdGhpcy5nZXRXZWJBcHAoZGF0YVtpbmRleF0ubWVudUluZm8/LndlYkFwcFBhdGgpIHx8ICcnO1xyXG4gICAgICBkYXRhW2luZGV4XS53ZWJBcHBSb3V0ZSA9IGRhdGFbaW5kZXhdLm1lbnVJbmZvPy53ZWJBcHBSb3V0ZSB8fCAnJztcclxuICAgICAgZGF0YVtpbmRleF0uaXNXZWJBcHAgPSAhIWRhdGFbaW5kZXhdLm1lbnVJbmZvPy5pc1dlYkFwcDtcclxuICAgICAgZGF0YVtpbmRleF0ucm91dGVyTGluayA9IGRhdGFbaW5kZXhdLm1lbnVJbmZvPy5pc1dlYkFwcCA/IGRhdGFbaW5kZXhdLndlYkFwcFJvdXRlIDogZGF0YVtpbmRleF0ucm91dGVyTGlua1xyXG4gICAgICBkYXRhW2luZGV4XS5yb3V0ZXJMaW5rQWN0aXZlT3B0aW9ucyA9IHsgZXhhY3Q6ICEhZGF0YVtpbmRleF0ubWVudUluZm8/LmlzV2ViQXBwIH07XHJcbiAgICAgIGRhdGFbaW5kZXhdLnVybCA9IHVuZGVmaW5lZDtcclxuICAgICAgZGF0YVtpbmRleF0ucE5hbWUgPSBwTmFtZTtcclxuICAgICAgZGF0YVtpbmRleF0uZ3JlYXRQTmFtZSA9IGdyZWF0UE5hbWU7XHJcbiAgICAgIGRhdGFbaW5kZXhdLml0ZW1zID1cclxuICAgICAgICBkYXRhW2luZGV4XS5tZW51Q2hpbGRyZW4ubGVuZ3RoID4gMCA/IGRhdGFbaW5kZXhdLm1lbnVDaGlsZHJlbiA6IHVuZGVmaW5lZDtcclxuICAgICAgaWYgKGRhdGFbaW5kZXhdLm1lbnVDaGlsZHJlbiAmJiBkYXRhW2luZGV4XS5tZW51Q2hpbGRyZW4ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHRoaXMuYnVpbGRUYWJsZVRyZWVEYXRhKGRhdGFbaW5kZXhdLm1lbnVDaGlsZHJlbiwgZGF0YVtpbmRleF0ubGFiZWwsIGRhdGFbaW5kZXhdPy5wTmFtZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGdldFdlYkFwcChzdHI6IHN0cmluZykge1xyXG4gICAgaWYgKCFzdHIgfHwgIShzdHI/LmluY2x1ZGVzKCdtb2R1bGVzJykpKSB7XHJcbiAgICAgIHJldHVybiBzdHJcclxuICAgIH1cclxuICAgIGNvbnN0IHVybHMgPSBzdHIuc3BsaXQoJ21vZHVsZXMnKVxyXG4gICAgaWYgKHVybHMubGVuZ3RoID4gMCkge1xyXG4gICAgICByZXR1cm4gbG9jYXRpb24ub3JpZ2luICsgJy9tb2R1bGVzJyArICh1cmxzWzFdIHx8ICcnKVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHN0clxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaXNFeHRlcm5hbE5ldHdvcmsoKSB7XHJcblxyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldE1lbnVJbmZvKG1lbnVUcmVlS2V5czogYW55LCBtZW51VHJlZTogYW55LCBrZXk6IHN0cmluZykge1xyXG4gICAgbGV0IG1lbnUgPSBudWxsXHJcbiAgICBtZW51VHJlZS5mb3JFYWNoKChpdGVtOiBhbnkpID0+IHtcclxuICAgICAgaWYgKGl0ZW0ubWVudUluZm8uaWQgPT09IGtleSkge1xyXG4gICAgICAgIG1lbnUgPSBpdGVtXHJcbiAgICAgIH1cclxuICAgIH0pXHJcblxyXG4gICAgdGhpcy5idWlsZE1lbnVEYXRhKFttZW51XSwgbWVudVRyZWVLZXlzKVxyXG4gICAgcmV0dXJuIG1lbnVcclxuICB9XHJcblxyXG4gIGJ1aWxkTWVudURhdGEoZGF0YTogYW55LCBtZW51VHJlZUtleXM6IEFycmF5PGFueT4pIHtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xyXG5cclxuICAgICAgY29uc3QgaW5kZXggPSBtZW51VHJlZUtleXMuZmluZEluZGV4KChpdGVtOiBhbnkpID0+IHtcclxuICAgICAgICByZXR1cm4gZGF0YVtpXS5tZW51SW5mby5pZCA9PT0gaXRlbS5tZW51SW5mb0lkXHJcbiAgICAgIH0pXHJcblxyXG4gICAgICBpZihpbmRleCA8IDApIHtcclxuICAgICAgICBkYXRhLnNwbGljZShpLCAxKTtcclxuICAgICAgICBpLS07XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuXHJcblxyXG4gICAgICBpZiAoZGF0YVtpXS5tZW51Q2hpbGRyZW4gJiYgZGF0YVtpXS5tZW51Q2hpbGRyZW4ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHRoaXMuYnVpbGRNZW51RGF0YShkYXRhW2ldLm1lbnVDaGlsZHJlbiwgbWVudVRyZWVLZXlzKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbn1cclxuIl19